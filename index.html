<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMood â¤ï¸</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #ff4757; }
        body { font-family: -apple-system, sans-serif; background: #fffafa; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: var(--primary); margin: 15px 0 5px 0; font-weight: 800; font-size: 22px; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; width: 100%; max-width: 500px; margin-bottom: 20px; }
        .btn { padding: 12px 2px; border: none; border-radius: 10px; font-size: 11px; font-weight: bold; color: white; cursor: pointer; transition: 0.15s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .btn:active { transform: scale(0.9); opacity: 0.8; }
        
        /* Renk GruplarÄ± */
        .ask { background: #ff4757; } 
        .ihtiyac { background: #ff7f50; } 
        .pozitif { background: #2ed573; } 
        .notr { background: #747d8c; } 
        .fiziksel { background: #ffa502; } 
        .negatif { background: #54a0ff; } 
        .gergin { background: #eb4d4b; } 

        .history { width: 100%; max-width: 500px; background: white; border-radius: 15px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        input[type="date"] { padding: 10px; border-radius: 8px; border: 1px solid #f1f2f6; font-size: 14px; width: 100%; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f2f6; }
        .mood-info { font-size: 13px; }
        .delete-btn { background: #fff0f0; color: #ff7675; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; }
        #status { font-size: 11px; color: #aaa; margin-bottom: 5px; }
    </style>
</head>
<body>

    <h1>SMood â¤ï¸</h1>
    <p id="status">BaÄŸlantÄ± aktif.</p>

    <div class="grid">
        <button class="btn ask" onclick="kaydet('Seni Ã‡ok Seviyorum â¤ï¸')">Seni Seviyorum</button>
        <button class="btn ask" onclick="kaydet('Seni Ã‡ok Ã–zledim ğŸ¥º')">Ã‡ok Ã–zledim</button>
        <button class="btn ask" onclick="kaydet('Seni GÃ¶rmek Ä°stiyorum ğŸ˜')">GÃ¶rmek Ä°stiyorum</button>
        <button class="btn ask" onclick="kaydet('Sana SarÄ±lmak Ä°stiyorum ğŸ¤—')">SarÄ±lmak Ä°stiyorum</button>
        <button class="btn ask" onclick="kaydet('Sesini Duymak Ä°stiyorum ğŸ˜Š')">Sesini Ã–zledim</button>

        <button class="btn ihtiyac" onclick="kaydet('Ä°lgi Ä°stiyorum ğŸ‘‰ğŸ‘ˆ')">Ä°lgi Ä°stiyorum</button>
        <button class="btn ihtiyac" onclick="kaydet('KonuÅŸalÄ±m mÄ±? ğŸ’¬')">KonuÅŸalÄ±m mÄ±?</button>
        <button class="btn ihtiyac" onclick="kaydet('BuluÅŸalÄ±m mÄ±? ğŸ ')">BuluÅŸalÄ±m mÄ±?</button>
        <button class="btn ihtiyac" onclick="kaydet('Destek LazÄ±m ğŸ¤')">DesteÄŸin LazÄ±m</button>

        <button class="btn pozitif" onclick="kaydet('Ã‡ok Mutluyum ğŸ˜„')">Ã‡ok Mutluyum</button>
        <button class="btn pozitif" onclick="kaydet('Huzurluyum ğŸ§˜')">Huzurluyum</button>
        <button class="btn pozitif" onclick="kaydet('Enerji Doluyum âš¡')">EnerjiÄŸim</button>
        <button class="btn pozitif" onclick="kaydet('Motiveyim ğŸ’ª')">Motiveyim</button>
        <button class="btn pozitif" onclick="kaydet('HeyecanlÄ±yÄ±m ğŸ¤©')">HeyecanlÄ±yÄ±m</button>

        <button class="btn notr" onclick="kaydet('Normal ğŸ˜')">Normalim</button>
        <button class="btn notr" onclick="kaydet('Sakin ğŸ˜Œ')">Sakinim</button>
        <button class="btn notr" onclick="kaydet('CanÄ±m SÄ±kÄ±ldÄ± â³')">SÄ±kÄ±ldÄ±m</button>

        <button class="btn fiziksel" onclick="kaydet('Yorgun Hissediyorum ğŸ¥±')">Yorgunum</button>
        <button class="btn fiziksel" onclick="kaydet('Uykum Var ğŸ˜´')">Uykum Var</button>
        <button class="btn fiziksel" onclick="kaydet('HastayÄ±m ğŸ¤’')">HastayÄ±m</button>
        <button class="btn fiziksel" onclick="kaydet('Ã‡ok YoÄŸunum ğŸ“š')">Ã‡ok YoÄŸunum</button>
        <button class="btn fiziksel" onclick="kaydet('AcÄ±ktÄ±m ğŸ”')">AcÄ±ktÄ±m</button>

        <button class="btn gergin" onclick="kaydet('KÄ±rgÄ±nÄ±m ğŸ’”')">KÄ±rgÄ±nÄ±m</button>
        <button class="btn gergin" onclick="kaydet('Sinirliyim ğŸ˜¡')">Sinirliyim</button>
        <button class="btn gergin" onclick="kaydet('BunalmÄ±ÅŸ Hissediyorum ğŸ˜‘')">BunaldÄ±m</button>
        <button class="btn gergin" onclick="kaydet('Kafam KarÄ±ÅŸÄ±k ğŸ˜£')">Kafam Ã‡ok KarÄ±ÅŸÄ±k</button>

        <button class="btn negatif" onclick="kaydet('Ã‡ok ÃœzgÃ¼nÃ¼m ğŸ˜¢')">Ã‡ok ÃœzgÃ¼nÃ¼m</button>
        <button class="btn negatif" onclick="kaydet('ÃœzgÃ¼nÃ¼m ğŸ˜¢')">Biraz ÃœzgÃ¼nÃ¼m</button>
        <button class="btn negatif" onclick="kaydet('KaygÄ±lÄ±yÄ±m ğŸ˜°')">KaygÄ±lÄ±yÄ±m</button>
        <button class="btn negatif" onclick="kaydet('Ã‡ok KÃ¶tÃ¼yÃ¼m ğŸ˜­')">Ã‡ok KÃ¶tÃ¼yÃ¼m</button>
    </div>

    <div class="history">
        <input type="date" id="dateFilter" onchange="tariheGoreGetir(this.value)">
        <h2 id="listTitle" style="font-size: 16px; margin: 0 0 10px 0; color: #ff4757;">GeÃ§miÅŸ Notlar</h2>
        <div id="history-list"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBdgJMWisTr5wlpzPmX8U5v4mDY4Gp5lvo",
            authDomain: "smood-fcef3.firebaseapp.com",
            databaseURL: "https://smood-fcef3-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "smood-fcef3",
            storageBucket: "smood-fcef3.firebasestorage.app",
            messagingSenderId: "481885978202",
            appId: "1:481885978202:web:5cd2527d3b2aaa5a416263"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let activeRef = null;

        async function kaydet(mod) {
            // 1. Haptic Feedback (TitreÅŸim)
            if (navigator.vibrate) {
                navigator.vibrate(50); 
            }

            const statusLabel = document.getElementById('status');
            statusLabel.innerText = "GÃ¶nderiliyor...";
            const tarih = new Date().toLocaleString('tr-TR');
            const ntfyKanal = "SMood_2026"; 

            // 2. ntfy Ã–ncelik Belirleme Logic'i
            // Kritik durumlar iÃ§in Ã¶nceliÄŸi 'high' (4) yapÄ±yoruz.
            const acilDurumlar = ['ÃœzgÃ¼n', 'KÃ¶tÃ¼', 'Destek', 'KÄ±rgÄ±n', 'Sinirli', 'KarÄ±ÅŸÄ±k'];
            const isHighPriority = acilDurumlar.some(kelime => mod.includes(kelime));
            const priorityLevel = isHighPriority ? "high" : "default";

            try {
                // Firebase'e Kaydet
                await db.ref('moodlar/').push({ 
                    durum: mod, 
                    zaman: tarih, 
                    timestamp: Date.now() 
                });

                // ntfy.sh Bildirimi
                const res = await fetch(`https://ntfy.sh/${ntfyKanal}`, { 
                    method: 'POST', 
                    body: `Yeni Durum: ${mod}`, 
                    headers: { 
                        'Title': 'SMood GÃ¼ncellemesi', 
                        'Priority': priorityLevel,
                        'Tags': isHighPriority ? 'warning,heart' : 'heart'
                    } 
                });

                if (res.ok) {
                    statusLabel.innerText = "Ona iletildi! â¤ï¸";
                } else {
                    statusLabel.innerText = "Bildirim sunucu hatasÄ±!";
                }

                setTimeout(() => statusLabel.innerText = "BaÄŸlantÄ± aktif.", 2000);
            } catch (e) { 
                console.error("Hata detayÄ±:", e);
                statusLabel.innerText = "Hata oluÅŸtu!"; 
                alert("BaÄŸlantÄ± HatasÄ±: " + e.message); 
            }
        }

        async function kayitSil(id) {
            if(confirm("Silmek istiyor musun?")) {
                try { await db.ref('moodlar/' + id).remove(); } catch (e) { alert("Hata!"); }
            }
        }

        function dinleyiciBaslat(ref, title) {
            if (activeRef) activeRef.off();
            activeRef = ref;
            activeRef.on('value', (snapshot) => { renderList(snapshot, title); });
        }

        function tariheGoreGetir(secilenTarih) {
            if (!secilenTarih) { varsayilanYukle(); return; }

            // Tarihi "2026-01-13" formatÄ±ndan parÃ§alara ayÄ±rÄ±yoruz (YÄ±l, Ay, GÃ¼n)
            const parcalar = secilenTarih.split('-');
            const yil = parseInt(parcalar[0]);
            const ay = parseInt(parcalar[1]) - 1; // JS'de aylar 0-11 arasÄ±dÄ±r
            const gun = parseInt(parcalar[2]);

            // Yerel saat dilimine gÃ¶re baÅŸlangÄ±Ã§ ve bitiÅŸi oluÅŸturuyoruz
            const baslangic = new Date(yil, ay, gun, 0, 0, 0, 0).getTime();
            const bitis = new Date(yil, ay, gun, 23, 59, 59, 999).getTime();

            const query = db.ref('moodlar/')
                            .orderByChild('timestamp')
                            .startAt(baslangic)
                            .endAt(bitis);

            dinleyiciBaslat(query, `${secilenTarih} NotlarÄ±`);
        }

        function varsayilanYukle() {
            const query = db.ref('moodlar/').orderByChild('timestamp').limitToLast(12);
            dinleyiciBaslat(query, "Son Notlar");
        }

        function renderList(snapshot, title) {
            document.getElementById('listTitle').innerText = title;
            const listElement = document.getElementById('history-list');
            listElement.innerHTML = "";
            let data = [];
            snapshot.forEach((snap) => { data.push({ id: snap.key, ...snap.val() }); });
            
            if (data.length === 0) { listElement.innerHTML = '<div style="text-align:center;color:#ccc;padding:10px;">KayÄ±t yok.</div>'; return; }

            data.reverse().forEach(item => {
                listElement.innerHTML += `
                    <div class="history-item">
                        <div class="mood-info">
                            <strong>${item.durum}</strong><br>
                            <small style="color:#aaa">${item.zaman}</small>
                        </div>
                        <button class="delete-btn" onclick="kayitSil('${item.id}')">âœ•</button>
                    </div>`;
            });
        }

        varsayilanYukle();
    </script>
</body>
</html>
