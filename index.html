<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMood Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #6c5ce7; }
        body { font-family: -apple-system, sans-serif; background: #f9f9fb; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: var(--primary); margin-top: 40px; font-weight: 800; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-bottom: 30px; }
        .btn { padding: 25px; border: none; border-radius: 18px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn:active { transform: scale(0.95); }
        .harika { background: #00b894; }
        .iyi { background: #55efc4; color: #2d3436; }
        .normal { background: #ffeaa7; color: #2d3436; }
        .yorgun { background: #fab1a0; color: #2d3436; }
        .uzgun { background: #74b9ff; }
        .kotu { background: #ff7675; }
        
        .history { width: 100%; max-width: 400px; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .history h2 { font-size: 18px; color: #2d3436; margin: 0 0 15px 0; }
        
        /* Filtreleme BÃ¶lÃ¼mÃ¼ */
        .filter-section { margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .filter-section label { font-size: 14px; color: #666; }
        input[type="date"] { padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; font-size: 16px; }

        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .history-item:last-child { border: none; }
        #status { font-size: 12px; color: #aaa; margin-bottom: 15px; }
        .no-data { text-align: center; color: #ccc; padding: 20px; font-style: italic; }
    </style>
</head>
<body>

    <h1>SMood</h1>
    <p id="status">BaÄŸlanÄ±yor...</p>

    <div class="grid">
        <button class="btn harika" onclick="kaydet('Harika ðŸ¤©')">Harika</button>
        <button class="btn iyi" onclick="kaydet('Ä°yi ðŸ˜Š')">Ä°yi</button>
        <button class="btn normal" onclick="kaydet('Normal ðŸ˜')">Normal</button>
        <button class="btn yorgun" onclick="kaydet('Yorgun ðŸ˜´')">Yorgun</button>
        <button class="btn uzgun" onclick="kaydet('ÃœzgÃ¼n ðŸ˜¢')">ÃœzgÃ¼n</button>
        <button class="btn kotu" onclick="kaydet('KÃ¶tÃ¼ ðŸ˜”')">KÃ¶tÃ¼</button>
    </div>

    <div class="history">
        <div class="filter-section">
            <label for="dateFilter">Tarihe GÃ¶re Bak:</label>
            <input type="date" id="dateFilter" onchange="tariheGoreGetir(this.value)">
        </div>
        
        <h2 id="listTitle">Son KayÄ±tlar</h2>
        <div id="history-list"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBdgJMWisTr5wlpzPmX8U5v4mDY4Gp5lvo",
            authDomain: "smood-fcef3.firebaseapp.com",
            databaseURL: "https://smood-fcef3-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "smood-fcef3",
            storageBucket: "smood-fcef3.firebasestorage.app",
            messagingSenderId: "481885978202",
            appId: "1:481885978202:web:5cd2527d3b2aaa5a416263"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Aktif dinleyiciyi takip etmek iÃ§in deÄŸiÅŸken
        let activeRef = null;

        // 1. Kaydetme Fonksiyonu (AynÄ± kalÄ±yor)
        async function kaydet(mod) {
            const statusLabel = document.getElementById('status');
            statusLabel.innerText = "Kaydediliyor...";
            const tarih = new Date().toLocaleString('tr-TR');

            try {
                await db.ref('moodlar/').push({
                    durum: mod,
                    zaman: tarih,
                    timestamp: Date.now()
                });

                fetch(`https://ntfy.sh/SMood`, {
                    method: 'POST',
                    body: `Mood: ${mod}`,
                    headers: { 'Title': 'SMood', 'Tags': 'heart_eyes' }
                });

                statusLabel.innerText = "Kaydedildi!";
                setTimeout(() => statusLabel.innerText = "Senkronize edildi.", 2000);
            } catch (e) {
                statusLabel.innerText = "Hata!";
            }
        }

        // 2. Merkezi Dinleyici BaÅŸlatma Fonksiyonu
        function dinleyiciBaslat(ref, title) {
            // EÄŸer halihazÄ±rda bir dinleyici varsa onu kapat (Ã‡akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in)
            if (activeRef) activeRef.off(); 

            activeRef = ref; // Yeni referansÄ± kaydet

            activeRef.on('value', (snapshot) => {
                renderList(snapshot, title);
            });
        }

        // 3. Tarihe GÃ¶re Filtreleme (ArtÄ±k CanlÄ±!)
        function tariheGoreGetir(secilenTarih) {
            if (!secilenTarih) {
                varsayilanYukle();
                return;
            }

            const startOfDay = new Date(secilenTarih).setHours(0, 0, 0, 0);
            const endOfDay = new Date(secilenTarih).setHours(23, 59, 59, 999);

            // SeÃ§ilen tarih aralÄ±ÄŸÄ±nÄ± CANLI dinle
            const query = db.ref('moodlar/')
                            .orderByChild('timestamp')
                            .startAt(startOfDay)
                            .endAt(endOfDay);

            dinleyiciBaslat(query, `${secilenTarih} Tarihindeki KayÄ±tlar`);
        }

        // 4. VarsayÄ±lan GÃ¶rÃ¼nÃ¼m (Son 8 KayÄ±t)
        function varsayilanYukle() {
            const query = db.ref('moodlar/').orderByChild('timestamp').limitToLast(8);
            dinleyiciBaslat(query, "Son KayÄ±tlar");
        }

        // 5. Listeyi Ekrana Basan Fonksiyon (AynÄ± kalÄ±yor)
        function renderList(snapshot, title) {
            document.getElementById('listTitle').innerText = title;
            const listElement = document.getElementById('history-list');
            listElement.innerHTML = "";
            
            let data = [];
            snapshot.forEach((snap) => { data.push(snap.val()); });
            
            if (data.length === 0) {
                listElement.innerHTML = '<div class="no-data">Bu tarihte kayÄ±t bulunamadÄ±.</div>';
                return;
            }

            data.reverse().forEach(item => {
                listElement.innerHTML += `
                    <div class="history-item">
                        <strong>${item.durum}</strong>
                        <span>${item.zaman}</span>
                    </div>`;
            });
            document.getElementById('status').innerText = "Veriler gÃ¼ncel.";
        }

        // Uygulama baÅŸladÄ±ÄŸÄ±nda varsayÄ±lanÄ± yÃ¼kle
        varsayilanYukle();
    </script>
</body>
</html>
